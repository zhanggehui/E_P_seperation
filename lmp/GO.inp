variable debug equal 1

### build system ################################################################
units real
boundary p p f
newton off
pair_style lj/cut/coul/cut 10.0
pair_modify shift yes mix geometric
#kspace_style pppm 1e-6
#kspace_modify slab nozforce
atom_style full
bond_style harmonic
angle_style harmonic
special_bonds lj/coul 0.0 0.0 0.5
read_data /home/liufeng_pkuhpc/lustre3/zgh/GO_MD/receive/NA_pool/0.7/GO.data extra/atom/types 1
### 在两侧建立原子墙 ####
mass 16 15.9994  # wall atom, same as O
pair_coeff 16 16 0.1521 3.1505742268315 10.0
lattice sc 2
variable zz internal 0.0
variable v equal "v_zz == -zlat*floor(-zlo/zlat) || v_zz == zlat*floor(zhi/zlat)"
create_atoms 16 box var v set z zz
lattice none 1
change_box all boundary p p s

if "${debug} > 0" then &
"write_data system.data" &
"write_coeff system.coeff"

### group definition ####################################################

group gra type 1:4
group go type 1:11
group walls type 16
group water type 12 13

### 定义上下压强 ###
group sol subtract all go walls
variable go_zlo equal bound(go,zmin)
variable go_zhi equal bound(go,zmax)
region upbox block EDGE EDGE EDGE EDGE $(v_go_zhi) EDGE
region lowbox block EDGE EDGE EDGE EDGE EDGE $(v_go_zlo)
variable upa atom grmask(sol,upbox)
variable lowa atom grmask(sol,lowbox)
group upwater variable upa
group lowwater variable lowa
group sol delete

variable up_vol equal "(zhi-v_go_zhi)/lz*vol"
compute upwater_peratom all stress/atom NULL
compute upwater_p all reduce sum c_upwater_peratom[1] c_upwater_peratom[2] c_upwater_peratom[3]
variable upwater_press equal -(c_upwater_p[1]+c_upwater_p[2]+c_upwater_p[3])/(3*v_up_vol)

variable low_vol equal "(v_go_zlo-zlo)/lz*vol"
compute lowwater_peratom all stress/atom NULL
compute lowwater_p all reduce sum c_lowwater_peratom[1] c_lowwater_peratom[2] c_lowwater_peratom[3]
variable lowwater_press equal -(c_lowwater_p[1]+c_lowwater_p[2]+c_lowwater_p[3])/(3*v_low_vol)

variable upa atom grmask(walls,upbox)
variable lowa atom grmask(walls,lowbox) 
group upwall variable upa
group lowwall variable lowa

##### minimize #########################################################
if "${debug} > 0" then &
"dump check all atom 100 check.dump"

group gra_and_HCAR type 1:4 11
group fix_atoms union gra_and_HCAR walls
fix freeze fix_atoms setforce 0 0 0
thermo_style custom step temp epair emol etotal press fmax
thermo 100
min_style sd
minimize 0.0 1.0e-8 2000 20000
unfix freeze
group gra_and_HCAR delete
group fix_atoms delete

group fix_atoms union gra walls
group free_atoms subtract all fix_atoms
group fix_atoms delete
fix freeze gra setforce 0 0 0
fix nfwall walls nve/noforce
velocity free_atoms create 300 30315 dist gaussian
fix nvt free_atoms nvt temp 300 300 100.0
fix rigid_water all shake 0.0001 20 1000 b 5 9 a 11
group HCAR type 11
fix down HCAR viscous 10
variable fupwall equal fcm(walls,z,upbox)
variable flowwall equal fcm(walls,z,lowbox)
thermo_style custom step temp etotal press v_upwater_press v_lowwater_press v_fupwall v_flowwall vol
thermo 1000
thermo_modify lost/bond warn
timestep 0.1
run 20000

unfix nfwall
unfix rigid_water
unfix down
group HCAR delete

write_dump all atom equ.data
if "${debug} > 0" then &
"undump check"

##### pressure control ###########################################

variable pressuredown equal 1.0
variable pressureup equal 1.0

variable ratio equal 1.013*6.02*1e-5/4.186
variable xy_area equal lx*ly

variable f_pressdown equal -v_pressuredown*v_xy_area*v_ratio
variable f_pullup equal v_pressureup*v_xy_area*v_ratio

fix upaf upwall aveforce 0 0 v_f_pressdown
fix lowaf lowwall aveforce 0 0 v_f_pullup
fix freeze_wall walls setforce 0 0 NULL
fix nve walls nve
fix h_bonds_shake all shake 0.0001 20 100 b 5 8 9 a 11
dump nvt all atom 10000 nvt.dump
thermo 10000
timestep 1
run 1000000
